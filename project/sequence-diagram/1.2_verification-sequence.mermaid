sequenceDiagram
    actor User
    participant Frontend
    participant AuthService
    participant Database
    participant MessageBroker
    participant ProcessorService

    User->>Frontend: Submit OTP from email
    Frontend->>AuthService: POST /api/v1/auth/otp/verify

    AuthService->>Database: getOtpVerificationByUsername()
    Database-->>AuthService: OtpVerification

    alt OTP expired, invalid, or account locked
        AuthService-->>Frontend: Error response
        Frontend-->>User: Display error message
    else Valid OTP
        AuthService->>Database: markOtpAsVerified()
        AuthService->>Database: enableUserAccount()

        AuthService->>AuthService: generateTokens()

        AuthService-->>Frontend: TokenResponse
        Frontend->>Frontend: Store tokens
        Frontend-->>User: Redirect to dashboard
    end

    alt Resend OTP
        User->>Frontend: Request new OTP
        Frontend->>AuthService: POST /api/v1/auth/otp/resend

        AuthService->>Database: regenerateOtp()
        AuthService->>MessageBroker: publishOtpEmailEvent(email, newOtp)
        MessageBroker-->>ProcessorService: consumeOtpEmailEvent(email, newOtp)
        ProcessorService-->>User: Send new verification email

        AuthService-->>Frontend: Success response
        Frontend-->>User: Display message to check email
    end
