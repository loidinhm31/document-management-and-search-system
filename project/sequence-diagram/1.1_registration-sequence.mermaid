sequenceDiagram
    actor User
    participant Frontend
    participant AuthService
    participant Database
    participant MessageBroker
    participant ProcessorService

    User->>Frontend: Fill registration form
    Frontend->>AuthService: POST /api/v1/auth/register

    AuthService->>Database: checkUsernameAndEmailAvailability()
    Database-->>AuthService: Available: true/false

    alt Username or email already exists
        AuthService-->>Frontend: 400 Bad Request
        Frontend-->>User: Display error message
    else Username and email are available
        AuthService->>Database: createUserWithDefaultRole()
        Database-->>AuthService: User (not verified)

        AuthService->>AuthService: generateOtpCode()
        AuthService->>Database: storeOtpVerification()

        AuthService->>MessageBroker: publishOtpEmailEvent(email, otp)
        MessageBroker-->>ProcessorService: consumeOtpEmailEvent(email, otp)
        ProcessorService-->>User: Send verification email with OTP

        AuthService-->>Frontend: 201 Created
        Frontend-->>User: Display success message and prompt to verify
    end